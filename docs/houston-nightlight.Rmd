---
title: 'Assessing Inequities During 2021 Houston Blackout'
author: "Briana Barajas"
date: "`r Sys.Date()`"
output:
    html_document:
      toc: yes
      toc_depth: 4
      toc_float: yes
format: 
  html:
    code-fold: true
    code-summary: "View Code"  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, results='hide'}
library(tidyverse)
library(stars)
library(sf)
library(ggspatial)
library(gridExtra)
library(here)
```

## Background (print_df: paged)

In February 2021, severe winter storms in the United States caused a major power outage in the state of Texas. The loss of power resulted in over 4.5 million homes and businesses left without power, and several deaths.[^1] This analysis uses remotely sensed night light data to assess the impact and distribution of these blackouts. Data from the U.S. Census Bureau will be added to investigate if socioeconomic factors affect the recovery of power within the community.

[^1]: <https://en.wikipedia.org/wiki/2021_Texas_power_crisis>

## About the Data

### Night Light Data

Data on the distribution of artificial night over the Houston area was acquired from the Visible Infrared Imaging Radiometer Suite (VIIRS) sensor, which is aboard the Suomi satellite. VNP46A1 will be used to visualize the difference in night light.[^2] This data is available through NASA's [Level-1 and Atmospheric Archive & Distribution System Distributed Active Archive Center (LAADS DAAC)](https://ladsweb.modaps.eosdis.nasa.gov/). Remote sensing images from 2021-02-07 and 2021-02-16 were selected, as this data was collected before and after the storm, and there is minimal cloud cover.

[^2]: <https://developers.google.com/earth-engine/datasets/catalog/NOAA_VIIRS_001_VNP46A1>

### Road and Home Data

Vehicles produce a large portion of night lights that are detected via remote sensing. Removing areas near highways from this analysis can decrease the chance of falsely identifying areas with low traffic as blackout zones. Data on highways was accessed through [Geofabrik](https://download.geofabrik.de/), and collected by [OpenStreetMap (OSM)](https://planet.openstreetmap.org/). Geobrik also cleans and provides OpenStreetMap(OSM) data on homes. This data was used to find the number of homes impacted by the blackouts.\

### Socioeconomic Data

Data on individual homes is not available, but socioeconomic information from the [U.S. Census Bureau](https://www.census.gov/programs-surveys/acs) provides income information within census tracts. The census data will be useful for estimating the average income for homes impacted by the blackouts.

## Data Reading & Preparation

### Night Light

Night light data from NASA is distributed as 10x10 degree tiles. In order to capture all of the Houston area, there are two tiles from each night of interest.

```{r, results = 'hide'}
# read in Houston tiles from 2021-02-07 
night_tile7_h5 <- read_stars(here('data/VNP46A1/VNP46A1.A2021038.h08v05.001.2021039064328.tif'))
night_tile7_h6 <- read_stars(here('data/VNP46A1/VNP46A1.A2021038.h08v06.001.2021039064329.tif'))

# read in Houston tiles from 2021-02-16
night_tile16_h5 <- read_stars(here('data/VNP46A1/VNP46A1.A2021047.h08v05.001.2021048091106.tif'))
night_tile16_h6 <- read_stars(here('data/VNP46A1/VNP46A1.A2021047.h08v06.001.2021048091105.tif'))

# combine data tiles
night_tile7 <- st_mosaic(night_tile7_h5, night_tile7_h6)
night_tile16 <- st_mosaic(night_tile16_h5, night_tile16_h6)

# remove uncombined tiles from env
rm(night_tile7_h5, night_tile7_h6, night_tile16_h5, night_tile16_h6)
```

### SQL Query - Home and Road Data

Standard Query Language, or SQL, was used to define parameters for filtering home and road data as it was read in. For the home search, buildings identified as residential, apartments, house, static caravans, or detached were included.

House data:

```{r, results='hide'}
#store query (data selection)
query1 <- "SELECT * FROM gis_osm_buildings_a_free_1 WHERE (type IS NULL AND name IS NULL) OR type in ('residential', 'apartments', 'house', 'static_caravan', 'detached')"

# read in data using query to filter
homes_raw <- st_read(here("data/gis_osm_buildings_a_free_1.gpkg"), query = query1)

# reproject data
homes_raw <- st_transform(homes_raw, crs = "EPSG:3083")

# map night lights from both nights
plot(night_tile7, main = "Feburary 7", axes = TRUE) 
plot(night_tile16, main = "February 16", axes = TRUE)
```

Road data:

```{r}
# define query (data selection)
query <- "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'"

#load in data
highway_raw <- st_read(here("data/gis_osm_roads_free_1.gpkg"), query = query)

# remove queries from environment
rm(query, query1)
```

## Finding Blackout Locations

By examining the change in night light intensity, we can potentially uncover areas where the storms affected power supply. For this analysis, blackout areas will be defined as areas that experienced a drop of more than 200 nW cm^-2^sr^-1^.

```{r}
# find the change in night light intensity
light_diff <- (night_tile7 - night_tile16)

# reclassify raster to define areas with and without blackouts
light_diff_reclassified <- cut(x = light_diff, 
                               breaks = c(-Inf, 200, Inf), #200 as blackout cutoff value
                      labels = c("No Blackout", "Blackout"))

# assign NAs to non-blackout areas
light_diff_reclassified[light_diff_reclassified == "No Blackout"] <- NA

plot(light_diff_reclassified, main = "Blackouts", axes = TRUE, col = c("aliceblue", "darkblue")) 
```

#### Find locations of blackouts

##### create a blackout mask (10 points)

-   find the change in night lights intensity (presumably) caused by the storm

-   reclassify the difference raster, assuming that any location that experienced a drop of more than 200 nW cm^-2^sr^-1^ experienced a blackout

-   assign `NA` to all locations that experienced a drop of *less* than 200 nW cm^-2^sr^-1^

    ```{r}
    #made a copy to preserve initial difference & compare for self-check
    light_diff_rcl_copy <- light_diff_reclassified

     #assign values to NA
    ```

    ```{r}
    # check that copy has been changed
    if (identical(light_diff_reclassified, light_diff_rcl_copy)) {
      print("NAs not properly assigned")
    } else {
      print("all good")
    }
    ```

    ```{r, eval = FALSE}
    # View blackout map w/NAs
      #the lighter color assigned to "No Blackouts" is missing since these values are NA
    plot(light_diff_rcl_copy, main = "Blackouts", axes = TRUE, col = c("aliceblue", "darkblue")) 
    ```

##### vectorize the mask (5 points)

-   use `st_as_sf()` to vectorize the blackout mask

    **ANSWER:**

    ```{r}
    # vectorze blackout mask
    lights_bo_mask <- st_as_sf(light_diff_rcl_copy)
    ```

    **CHECKS:**

    ```{r}
    # check that the mask is now a df
    if(is.data.frame(lights_bo_mask)) {
      print("yippeee!")
    } else {
      print("try again silly goose")
    }
    ```

    ```{r}
    # check that only areas w/blackouts were included
    unique(lights_bo_mask$VNP46A1.A2021038.h08v05.001.2021039064328.tif)
    ```

-   fix any invalid geometries using `st_make_valid`

    ```{r}
    # fix invalid geometries using 
    lights_bo_mask <- st_make_valid(lights_bo_mask)
    ```

##### crop the vectorized map to our region of interest (10 points)

-   define the Houston metropolitan area with the following coordinates: (-96.5, 29), (-96.5, 30.5), (-94.5, 30.5), (-94.5, 29)

    **ANSWER:**

    ```{r}
    # create matrix using points that contain houston
    # duplicate first point to close polygon
    houston_matrix <- matrix(c(-96.5, 29, -96.5, 30.5, -94.5, 30.5, -94.5, 29, -96.5, 29),
                             ncol = 2, byrow = TRUE)
    ```

-   turn these coordinates into a polygon using `st_polygon` & convert the polygon into a simple feature collection using `st_sfc()` and assign a CRS. Hint: because we are using this polygon to crop the night lights data it needs the same CRS

    **ANSWER:**

    ```{r}
    # defined polygon and CRS in single step
    houston_polygon <- st_sfc(st_polygon(list(houston_matrix)) #create polygon using matrix
                      , crs = "EPSG:4326") #assign CRS
    ```

    **CHECKS:**

    ```{r}
    # check if CRS are the same
    if(st_crs(houston_polygon) == st_crs(lights_bo_mask)) {
      print("CRS match")
    } else {
      print("CRS do not match")
    }
    ```

    ```{r, eval = FALSE}
    #plot polygon to check if a rectangle around Houston is returned
    ggplot(houston_polygon) +
      geom_sf()
    ```

-   crop (spatially subset) the blackout mask to our region of interest 

    **ANSWER:**

    ```{r, warning=FALSE}
    # crop blackout data w/NAs to Houston 
    houston_lights_bo_mask <- st_crop(lights_bo_mask, st_bbox(houston_polygon))
    ```

    **CHECKS:**

    ```{r, eval=FALSE}
    # plot to check if blackout data was properly cropped to houston
    ggplot(houston_lights_bo_mask) +
      geom_sf()
    ```

-   re-project the cropped blackout dataset to EPSG:3083 (NAD83 / Texas Centric Albers Equal Area)

    ```{r}
    # change CRS of cropped dataset
    houston_lights_bo_mask <- st_transform(houston_lights_bo_mask, crs = "EPSG:3083")
    ```

    ```{r, eval=FALSE}
    # check if CRS updates
    st_crs(houston_lights_bo_mask)
    ```

##### exclude highways from blackout mask (10 points)

The roads geopackage includes data on roads other than highways. However, we can avoid reading in data we don't need by taking advantage of `st_read`'s ability to subset using a SQL query.

-   define SQL query

    **ANSWER:** SQL, or Standard Query Language, is used for database management, filtering, and access. In our case, we'll be using an **SQL query** which defines a set of parameters that will be used to filter the data before it's stored as an object. This can be done within `st_read` using `SELECT` and `FROM`.

-   load just highway data from geopackage using `st_read`

    ```{r, warning=FALSE, message=FALSE, results='hide'}
    # define query (data selection)
    query <- "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'"

    #load in data
    highway_raw <- st_read(here("data/gis_osm_roads_free_1.gpkg"), query = query)
    ```

-   reproject data to EPSG:3083

    ```{r, warning=FALSE, message=FALSE}
    # update CRS
    highway_raw <- st_transform(highway_raw, crs = "EPSG:3083")
    ```

    ```{r, eval=FALSE}
    # check CRS has been updated
    st_crs(highway_raw)
    ```

-   Identify areas within 200m of all highways using `st_buffer`. Hint: `st_buffer` produces undissolved buffers, use `st_union` to dissolve them

    ```{r}
    #create buffer 200m away from roads
    hwy_buffer <- st_union(st_buffer(x = highway_raw, dist = 200))
    ```

    ```{r, eval=FALSE}
    # plot buffer to check that union worked
    ggplot(hwy_buffer) +
      geom_sf()
    ```

-   find areas that experienced blackouts that are further than 200m from a highway

    ```{r, warning=FALSE}
    bo_areas <- st_difference(houston_lights_bo_mask, hwy_buffer)

    bo_area_count <- nrow(bo_areas)
    sprintf("Blackout areas further than 200m away from a highway: %d", bo_area_count)
    ```

`query <- "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'"`\
`highways <- st_read("data/gis_osm_roads_free_1.gpkg", query = query)`

#### Find homes impacted by blackouts

##### load buildings data (10 points)

-   Load buildings dataset using `st_read` and the following SQL query to select only residential buildings. Hint: reproject data to EPSG:3083

**-2 in SQL query should be "detached" not "detach". Resulted in missing some houses**

    ```{r, warning=FALSE, message=FALSE, results='hide'}
    #store query (data selection)
    query1 <- "SELECT * FROM gis_osm_buildings_a_free_1 WHERE (type IS NULL AND name IS NULL) OR type in ('residential', 'apartments', 'house', 'static_caravan', 'detatch')"

    # read in data using query to filter
    homes_raw <- st_read(here("data/gis_osm_buildings_a_free_1.gpkg"), query = query1)

    #change the CRS
    homes_raw <- st_transform(homes_raw, crs = "EPSG:3083")
    ```

    `SELECT *`  `FROM gis_osm_buildings_a_free_1`\
    `WHERE (type IS NULL AND name IS NULL)`\
    `OR type in ('residential', 'apartments', 'house', 'static_caravan', 'detached')`

##### find homes in blackout areas (20 points)

-   filter to homes within blackout areas

    ```{r}
    #filter to homes within blackout area
    bo_homes <- homes_raw %>%
      st_filter(y = bo_areas, .predicate = st_intersects)
    ```

-   count number of impacted homes

    ```{r}
    #print statement with result
    bo_homes_count <- nrow(bo_homes)
    sprintf("Homes in blackout areas: %d", bo_homes_count)
    ```

#### Investigate socioeconomic factors

##### load ACS data (10 points)

-   use `st_read()` to load the geodatabase layers

    ```{r}
    #store file path to geodatabase layers
    path <- here("data/ACS_2019_5YR_TRACT_48_TEXAS.gdb")
    ```

    ```{r, eval = FALSE}
    # view all layers
    st_layers(path)
    ```

-   geometries are stored in the `ACS_2019_5YR_TRACT_48_TEXAS` layer and income data is stored in the `X19_INCOME` layer

    ```{r, warning=FALSE, message=FALSE, results='hide'}
    #store geometry layer
    tract_layer_raw <- st_read(dsn = path, layer = "ACS_2019_5YR_TRACT_48_TEXAS")

    #store income layer
    income_layer_raw <- st_read(dsn = path, layer = "X19_INCOME")
    ```

-   select the median income field `B19013e1`

    ```{r}
    #filter to only median income column
    income <- income_layer_raw %>%
      select(B19013e1, GEOID) %>%
      rename(GEOID_Data = GEOID,
             median_income = B19013e1) #rename 

    # filtered Census tract layer to speed up joins
    tract_layer_raw <- tract_layer_raw %>% 
      select(GEOID_Data, NAMELSAD) %>% 
      rename(census_tract = NAMELSAD)
    ```

-   hint: reproject data to EPSG:3083

    **ANSWER:**

    ```{r}
    # census tracts are only layer w/geometries, only change one CRS
    tract_layer_raw <- st_transform(tract_layer_raw, crs = "EPSG:3083")
    ```

    **CHECK:**

    ```{r, eval=FALSE}
    # check udpdated CRS
    st_crs(tract_layer_raw)
    ```

##### determine which census tracts experienced blackouts (10 points)

-   Join the income data to the census tract geometries. Hint: make sure to join by geometry ID

**Census tract number off by 1 due to missed buildings in sequel query**

    ```{r}
    # join income and census tract data
    inc_tract_joined <- inner_join(tract_layer_raw, income, by = "GEOID_Data")

    # group census groups into a single row
    inc_tract_joined <- inc_tract_joined %>% 
      group_by(census_tract) %>% 
      mutate(median_income = mean(median_income, na.rm = TRUE))
    ```

-   spatially join census tract data with buildings determined to be impacted by blackouts

    ```{r}
    #some census tracts have multiple GEOIDs, after joining group by tract & find mean inc
    full_bo_data <- st_join(bo_homes, inc_tract_joined, join = st_intersects)
    ```

-   find which census tracts had blackouts

    ```{r, eval=FALSE}
    # name census tracts w/blackouts (too many to print, eval=FALSE)
    unique(full_bo_data$census_tract)
    ```

    ```{r}
    # check number of census tracts w/black outs
    tract_bo_count <- length(unique(full_bo_data$census_tract))
    sprintf("Number of census tracts with blackouts: %d", tract_bo_count)
    ```

##### compare incomes of impacted tracts to unimpacted tracts (10 points)

-   create a map of median income by census tract, designating which tracts had blackouts

**-1 plotted all buildings instead of designating tracts**

    ```{r, warning=FALSE}
    #update polygon crs to use here
    houston_polygon <- st_transform(houston_polygon, crs = "EPSG:3083")

    # crop full texas to Houston for basemap
    houston_basemap <- st_crop(inc_tract_joined, houston_polygon)
    ```

    ```{r}
    ggplot() +
      geom_sf(data = houston_basemap, aes(fill = median_income)) + #color by inc data
      scale_fill_gradient(low = '#D5F5E3', high = '#186A3B') + #set low+high inc gradient
      labs(fill = "Median Icome",
           title = "2021 Houston Winter Storm Blackout Areas") +
      geom_sf(data = full_bo_data, color = '#8C0D50', alpha = 0.2) + #add bo areas
      annotation_scale(pad_x = unit(8.4, 'cm'), #add scale, adjust size and position
                       pad_y = unit(0.5, 'cm'),
                       height = unit(0.2, 'cm')) +
      annotation_north_arrow(height = unit(0.7, 'cm'), #add arrow, adjust size and position
                             width = unit(0.7, 'cm'),
                             pad_x = unit(11.2, "cm"),
                             pad_y = unit(9.5, "cm")) +
      theme_minimal() + #change theme, lighten graticultes
      theme(plot.title = element_text(hjust = 0.5)) #center title
    ```

-   Plot the distribution of income in impacted and unimpacted tracts

**-1 impacted and unimpacted have many duplicates which effects distribution**

    ```{r}
    # drop geometries of bo data to anti-join w/non-blackout
    impacted <- full_bo_data %>% st_drop_geometry() %>% 
      select('GEOID_Data', 'census_tract', 'median_income')

    #anti-join to find areas w/NO blackouts
    unimpacted <- anti_join(x = inc_tract_joined, y = impacted, by = "census_tract")
    ```

    ```{r, warning=FALSE}
    impacted_distribution <- ggplot(data = impacted, aes(x=median_income)) +
      geom_histogram(fill = '#8C0D50', bins = 50) +
      labs(title = "Income - Areas Impacted by Blackouts",
           x="Median Income",
           y="Frequency") +
      theme_minimal()

    unimpacted_distribution <- ggplot(data = unimpacted, aes(x=median_income)) +
      geom_histogram(fill = '#16A085', bins = 50) +
      labs(title = "Income - Areas Unimpacted by Blackouts",
           x="Median Income",
           y="Frequency") +
      theme_minimal()

    grid.arrange(impacted_distribution, unimpacted_distribution, ncol=1)
    ```

-   write approx. 100 words summarizing your results and discussing any limitations to this study

    This study uses aerial images of night lights in Houston to asses blackouts caused by a winter storm in February 2021. The difference in radiance between a night before and during the storm was used to determine areas where blackouts occurred. In order to improve this estimate, areas within 200m of highways were removed to avoid designating more rural areas as having had blackouts. Finally, homes in blackout areas were combined with data on the corresponding census tract and median income. Based on the distribution, displayed above, there does not appear to be a clear relationship between median income and whether or not an area experienced a blackout. Although there are more areas impacted by blackouts with a median income under 50,000, there are also many high income areas (around 150,000) that were also impacted. This study provides a meaningful preliminary exploration on the relationship socioeconomic factors and the 2021 winter storm blackouts, but more work could be done. Using changes in night lights from two nights does not tell us about potential disparities regarding emergency resource distribution, blackout length, or individual impacts.

##### Learning objectives:

-   load vector/raster data
-   simple raster operations
-   simple vector operations
-   spatial joins
