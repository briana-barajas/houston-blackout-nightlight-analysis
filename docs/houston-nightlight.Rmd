---
title: 'EDS 223: assignment 3'
author: "Briana Barajas"
date: "`r Sys.Date()`"
output:
    html_document:
      print_df: paged
      toc: yes
      toc_depth: 4
      toc_float: yes
---

**Good stylistically**

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview

"In February 2021, the state of Texas suffered a major power crisis, which came about as a result of three severe winter storms sweeping across the United States on February 10--11, 13--17, and 15--20."[^1] For more background, check out these [engineering](https://www.youtube.com/watch?v=08mwXICY4JM&ab_channel=PracticalEngineering) and [political](https://www.youtube.com/watch?v=Zcrsgdl_hP0&ab_channel=Vox) perspectives.

[^1]: Wikipedia. 2021. "2021 Texas power crisis." Last modified October 2, 2021. <https://en.wikipedia.org/wiki/2021_Texas_power_crisis>.

For this assignment, you are tasked with:\
- estimating the number of homes in Houston that lost power as a result of the first two storms\
- investigating if socioeconomic factors are predictors of communities recovery from a power outage

Your analysis will be based on remotely-sensed night lights data, acquired from the [Visible Infrared Imaging Radiometer Suite (VIIRS)](https://en.wikipedia.org/wiki/Visible_Infrared_Imaging_Radiometer_Suite) onboard the Suomi satellite. In particular, you will use the VNP46A1 to detect differences in night lights before and after the storm to identify areas that lost electric power.

To determine the number of homes that lost power, you link (spatially join) these areas with [OpenStreetMap](https://www.openstreetmap.org/#map=4/38.01/-95.84) data on buildings and roads.

To investigate potential socioeconomic factors that influenced recovery, you will link your analysis with data from the US Census Bureau.

##### Learning objectives:

-   load vector/raster data\
-   simple raster operations\
-   simple vector operations\
-   spatial joins

### Data

#### Night lights

Use NASA's Worldview to explore the data around the day of the storm. There are several days with too much cloud cover to be useful, but 2021-02-07 and 2021-02-16 provide two clear, contrasting images to visualize the extent of the power outage in Texas.

VIIRS data is distributed through NASA's [Level-1 and Atmospheric Archive & Distribution System Distributed Active Archive Center (LAADS DAAC)](https://ladsweb.modaps.eosdis.nasa.gov/). Many NASA Earth data products are distributed in 10x10 degree tiles in sinusoidal equal-area projection. Tiles are identified by their horizontal and vertical position in the grid. Houston lies on the border of tiles h08v05 and h08v06. We therefore need to download two tiles per date.

As you're learning in EDS 220, accessing, downloading, and preparing remote sensing data is a skill in it's own right! To prevent this assignment from being a large data wrangling challenge, we have downloaded and prepped the following files for you to work with, stored in the `VNP46A1` folder.\

-   `VNP46A1.A2021038.h08v05.001.2021039064328.h5.tif`: tile h08v05, collected on 2021-02-07\
-   `VNP46A1.A2021038.h08v06.001.2021039064329.h5.tif`: tile h08v06, collected on 2021-02-07\
-   `VNP46A1.A2021047.h08v05.001.2021048091106.h5.tif`: tile h08v05, collected on 2021-02-16\
-   `VNP46A1.A2021047.h08v06.001.2021048091105.h5.tif`: tile h08v06, collected on 2021-02-16

#### Roads

Typically highways account for a large portion of the night lights observable from space (see Google's [Earth at Night](https://earth.google.com/web/@27.44405464,-84.7693044,206.63660162a,8916361.52264659d,35y,0h,0t,0r/data=CiQSIhIgMGY3ZTJkYzdlOGExMTFlNjk5MGQ2ZjgxOGQ2OWE2ZTc)). To minimize falsely identifying areas with reduced traffic as areas without power, we will ignore areas near highways.

[OpenStreetMap (OSM)](https://planet.openstreetmap.org/) is a collaborative project which creates publicly available geographic data of the world. Ingesting this data into a database where it can be subsetted and processed is a large undertaking. Fortunately, third party companies redistribute OSM data. We used [Geofabrik's download sites](https://download.geofabrik.de/) to retrieve a shapefile of all highways in Texas and prepared a Geopackage (`.gpkg` file) containing just the subset of roads that intersect the Houston metropolitan area. 

-   `gis_osm_roads_free_1.gpkg`

#### Houses

We can also obtain building data from OpenStreetMap. We again downloaded from Geofabrick and prepared a GeoPackage containing only houses in the Houston metropolitan area.\

-   `gis_osm_buildings_a_free_1.gpkg`

#### Socioeconomic

We cannot readily get socioeconomic information for every home, so instead we obtained data from the [U.S. Census Bureau's American Community Survey](https://www.census.gov/programs-surveys/acs) for census tracts in 2019. The *folder* `ACS_2019_5YR_TRACT_48.gdb` is an ArcGIS ["file geodatabase"](https://desktop.arcgis.com/en/arcmap/latest/manage-data/administer-file-gdbs/file-geodatabases.htm), a multi-file proprietary format that's roughly analogous to a GeoPackage file.\

You can use `st_layers()` to explore the contents of the geodatabase. Each layer contains a subset of the fields documents in the [ACS metadata](https://www2.census.gov/geo/docs/maps-data/data/tiger/prejoined/ACSMetadata2011.txt).\

The geodatabase contains a layer holding the geometry information, separate from the layers holding the ACS attributes. You have to combine the geometry with the attributes to get a feature layer that `sf` can use.

## Assignment

### ⭐  Note on Self-Checks ⭐ 

Throughout my code I included a few code chunks where `eval = FALSE`, these are some self-checks with longer outputs such as plots, viewing data, or viewing the CRS. Any chunks that appear to have not run were intentional. Additionally, I have some handwritten notes that I'll add to the .Rproj titled `self-check-written`.

### Analysis Preparation

Load necessary libraries:

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(stars)
library(sf)
library(ggspatial)
library(gridExtra)
```

#### Find locations of blackouts

For improved computational efficiency and easier interoperability with `sf`, I recommend using the `stars` package for raster handling.

##### combine the data (5 points)

-   read in night lights tiles

    ```{r, warning=FALSE, message=FALSE}
    # load rasters from Houston tiles on 2021-02-07 (h5 unlabeled)
    night_tile7 <- read_stars('data/VNP46A1/VNP46A1.A2021038.h08v05.001.2021039064328.tif')
    night_tile7_h6 <- read_stars('data/VNP46A1/VNP46A1.A2021038.h08v06.001.2021039064329.tif')

    # load rasters from Houston tiles on 2021-02-16 (h5 unlabeled)
    night_tile16 <- read_stars('data/VNP46A1/VNP46A1.A2021047.h08v05.001.2021048091106.tif')
    night_tile16_h6 <- read_stars('data/VNP46A1/VNP46A1.A2021047.h08v06.001.2021048091105.tif')
    ```

-   combine tiles into a single `stars` object for each date (2021-02-07 and 2021-02-16). Hint: use `st_mosaic`

    ```{r}
    # combine tiles using st_mosaic, 2 tiles per night
    night_tile7 <- st_mosaic(night_tile7, night_tile7_h6)
    night_tile16 <- st_mosaic(night_tile16, night_tile16_h6)
    ```

##### create a blackout mask (10 points)

-   find the change in night lights intensity (presumably) caused by the storm

    ```{r, eval = FALSE}
    # View initial plots
    plot(night_tile7, main = "Feburary 7", axes = TRUE) 
    plot(night_tile16, main = "February 16", axes = TRUE)
    ```

    ```{r}
    #find the change in night light intensity
    light_diff <- (night_tile7 - night_tile16)
    ```

    ```{r, eval = FALSE}
    # plot to compare to initial plots
    plot(light_diff, main = "Change in Night Light Intensity", axes = TRUE)
    ```

-   reclassify the difference raster, assuming that any location that experienced a drop of more than 200 nW cm^-2^sr^-1^ experienced a blackout

    ```{r}
    # reclassify difference raster using the 200 marker as a break
    light_diff_reclassified <- cut(x = light_diff, breaks = c(-Inf, 200, Inf),
                          labels = c("No Blackout", "Blackout")) #labels 
    ```

    ```{r, eval = FALSE}
    plot(light_diff_reclassified, main = "Blackouts", axes = TRUE, col = c("aliceblue", "darkblue"))
    ```

    **Note:** I was initially trying to use `raster::reclassify()` in order to complete this but found it was not working. After some digging, I found that the `reclassify()` function was not working because the rasters have object class `stars`. I started looking for a similar function within the `stars` package, and found the `cut()` function, which was listed as an alternative to `reclassify()` in the `raster` package documentation. I am assuming this is some dependency.

-   assign `NA` to all locations that experienced a drop of *less* than 200 nW cm^-2^sr^-1^

    ```{r}
    #made a copy to preserve initial difference & compare for self-check
    light_diff_rcl_copy <- light_diff_reclassified

    light_diff_rcl_copy[light_diff_rcl_copy == "No Blackout"] <- NA #assign values to NA
    ```

    ```{r}
    # check that copy has been changed
    if (identical(light_diff_reclassified, light_diff_rcl_copy)) {
      print("NAs not properly assigned")
    } else {
      print("all good")
    }
    ```

    ```{r, eval = FALSE}
    # View blackout map w/NAs
      #the lighter color assigned to "No Blackouts" is missing since these values are NA
    plot(light_diff_rcl_copy, main = "Blackouts", axes = TRUE, col = c("aliceblue", "darkblue")) 
    ```

##### vectorize the mask (5 points)

-   use `st_as_sf()` to vectorize the blackout mask

    **ANSWER:**

    ```{r}
    # vectorze blackout mask
    lights_bo_mask <- st_as_sf(light_diff_rcl_copy)
    ```

    **CHECKS:**

    ```{r}
    # check that the mask is now a df
    if(is.data.frame(lights_bo_mask)) {
      print("yippeee!")
    } else {
      print("try again silly goose")
    }
    ```

    ```{r}
    # check that only areas w/blackouts were included
    unique(lights_bo_mask$VNP46A1.A2021038.h08v05.001.2021039064328.tif)
    ```

-   fix any invalid geometries using `st_make_valid`

    ```{r}
    # fix invalid geometries using 
    lights_bo_mask <- st_make_valid(lights_bo_mask)
    ```

##### crop the vectorized map to our region of interest (10 points)

-   define the Houston metropolitan area with the following coordinates: (-96.5, 29), (-96.5, 30.5), (-94.5, 30.5), (-94.5, 29)

    **ANSWER:**

    ```{r}
    # create matrix using points that contain houston
    # duplicate first point to close polygon
    houston_matrix <- matrix(c(-96.5, 29, -96.5, 30.5, -94.5, 30.5, -94.5, 29, -96.5, 29),
                             ncol = 2, byrow = TRUE)
    ```

-   turn these coordinates into a polygon using `st_polygon` & convert the polygon into a simple feature collection using `st_sfc()` and assign a CRS. Hint: because we are using this polygon to crop the night lights data it needs the same CRS

    **ANSWER:**

    ```{r}
    # defined polygon and CRS in single step
    houston_polygon <- st_sfc(st_polygon(list(houston_matrix)) #create polygon using matrix
                      , crs = "EPSG:4326") #assign CRS
    ```

    **CHECKS:**

    ```{r}
    # check if CRS are the same
    if(st_crs(houston_polygon) == st_crs(lights_bo_mask)) {
      print("CRS match")
    } else {
      print("CRS do not match")
    }
    ```

    ```{r, eval = FALSE}
    #plot polygon to check if a rectangle around Houston is returned
    ggplot(houston_polygon) +
      geom_sf()
    ```

-   crop (spatially subset) the blackout mask to our region of interest 

    **ANSWER:**

    ```{r, warning=FALSE}
    # crop blackout data w/NAs to Houston 
    houston_lights_bo_mask <- st_crop(lights_bo_mask, st_bbox(houston_polygon))
    ```

    **CHECKS:**

    ```{r, eval=FALSE}
    # plot to check if blackout data was properly cropped to houston
    ggplot(houston_lights_bo_mask) +
      geom_sf()
    ```

-   re-project the cropped blackout dataset to EPSG:3083 (NAD83 / Texas Centric Albers Equal Area)

    ```{r}
    # change CRS of cropped dataset
    houston_lights_bo_mask <- st_transform(houston_lights_bo_mask, crs = "EPSG:3083")
    ```

    ```{r, eval=FALSE}
    # check if CRS updates
    st_crs(houston_lights_bo_mask)
    ```

##### exclude highways from blackout mask (10 points)

The roads geopackage includes data on roads other than highways. However, we can avoid reading in data we don't need by taking advantage of `st_read`'s ability to subset using a SQL query.

-   define SQL query

    **ANSWER:** SQL, or Standard Query Language, is used for database management, filtering, and access. In our case, we'll be using an **SQL query** which defines a set of parameters that will be used to filter the data before it's stored as an object. This can be done within `st_read` using `SELECT` and `FROM`.

-   load just highway data from geopackage using `st_read`

    ```{r, warning=FALSE, message=FALSE, results='hide'}
    # define query (data selection)
    query <- "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'"

    #load in data
    highway_raw <- st_read("data/gis_osm_roads_free_1.gpkg", query = query)
    ```

-   reproject data to EPSG:3083

    ```{r, warning=FALSE, message=FALSE}
    # update CRS
    highway_raw <- st_transform(highway_raw, crs = "EPSG:3083")
    ```

    ```{r, eval=FALSE}
    # check CRS has been updated
    st_crs(highway_raw)
    ```

-   Identify areas within 200m of all highways using `st_buffer`. Hint: `st_buffer` produces undissolved buffers, use `st_union` to dissolve them

    ```{r}
    #create buffer 200m away from roads
    hwy_buffer <- st_union(st_buffer(x = highway_raw, dist = 200))
    ```

    ```{r, eval=FALSE}
    # plot buffer to check that union worked
    ggplot(hwy_buffer) +
      geom_sf()
    ```

-   find areas that experienced blackouts that are further than 200m from a highway

    ```{r, warning=FALSE}
    bo_areas <- st_difference(houston_lights_bo_mask, hwy_buffer)

    bo_area_count <- nrow(bo_areas)
    sprintf("Blackout areas further than 200m away from a highway: %d", bo_area_count)
    ```

`query <- "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'"`\
`highways <- st_read("data/gis_osm_roads_free_1.gpkg", query = query)`

#### Find homes impacted by blackouts

##### load buildings data (10 points)

-   Load buildings dataset using `st_read` and the following SQL query to select only residential buildings. Hint: reproject data to EPSG:3083

**-2 in SQL query should be "detached" not "detach". Resulted in missing some houses**

    ```{r, warning=FALSE, message=FALSE, results='hide'}
    #store query (data selection)
    query1 <- "SELECT * FROM gis_osm_buildings_a_free_1 WHERE (type IS NULL AND name IS NULL) OR type in ('residential', 'apartments', 'house', 'static_caravan', 'detatch')"

    # read in data using query to filter
    homes_raw <- st_read("data/gis_osm_buildings_a_free_1.gpkg", query = query1)

    #change the CRS
    homes_raw <- st_transform(homes_raw, crs = "EPSG:3083")
    ```

    `SELECT *`  `FROM gis_osm_buildings_a_free_1`\
    `WHERE (type IS NULL AND name IS NULL)`\
    `OR type in ('residential', 'apartments', 'house', 'static_caravan', 'detached')`

##### find homes in blackout areas (20 points)

-   filter to homes within blackout areas

    ```{r}
    #filter to homes within blackout area
    bo_homes <- homes_raw %>%
      st_filter(y = bo_areas, .predicate = st_intersects)
    ```

-   count number of impacted homes

    ```{r}
    #print statement with result
    bo_homes_count <- nrow(bo_homes)
    sprintf("Homes in blackout areas: %d", bo_homes_count)
    ```

#### Investigate socioeconomic factors

##### load ACS data (10 points)

-   use `st_read()` to load the geodatabase layers

    ```{r}
    #store file path to geodatabase layers
    path <- "data/ACS_2019_5YR_TRACT_48_TEXAS.gdb"
    ```

    ```{r, eval = FALSE}
    # view all layers
    st_layers(path)
    ```

-   geometries are stored in the `ACS_2019_5YR_TRACT_48_TEXAS` layer and income data is stored in the `X19_INCOME` layer

    ```{r, warning=FALSE, message=FALSE, results='hide'}
    #store geometry layer
    tract_layer_raw <- st_read(dsn = path, layer = "ACS_2019_5YR_TRACT_48_TEXAS")

    #store income layer
    income_layer_raw <- st_read(dsn = path, layer = "X19_INCOME")
    ```

-   select the median income field `B19013e1`

    ```{r}
    #filter to only median income column
    income <- income_layer_raw %>%
      select(B19013e1, GEOID) %>%
      rename(GEOID_Data = GEOID,
             median_income = B19013e1) #rename 

    # filtered Census tract layer to speed up joins
    tract_layer_raw <- tract_layer_raw %>% 
      select(GEOID_Data, NAMELSAD) %>% 
      rename(census_tract = NAMELSAD)
    ```

-   hint: reproject data to EPSG:3083

    **ANSWER:**

    ```{r}
    # census tracts are only layer w/geometries, only change one CRS
    tract_layer_raw <- st_transform(tract_layer_raw, crs = "EPSG:3083")
    ```

    **CHECK:**

    ```{r, eval=FALSE}
    # check udpdated CRS
    st_crs(tract_layer_raw)
    ```

##### determine which census tracts experienced blackouts (10 points)

-   Join the income data to the census tract geometries. Hint: make sure to join by geometry ID

**Census tract number off by 1 due to missed buildings in sequel query**

    ```{r}
    # join income and census tract data
    inc_tract_joined <- inner_join(tract_layer_raw, income, by = "GEOID_Data")

    # group census groups into a single row
    inc_tract_joined <- inc_tract_joined %>% 
      group_by(census_tract) %>% 
      mutate(median_income = mean(median_income, na.rm = TRUE))
    ```

-   spatially join census tract data with buildings determined to be impacted by blackouts

    ```{r}
    #some census tracts have multiple GEOIDs, after joining group by tract & find mean inc
    full_bo_data <- st_join(bo_homes, inc_tract_joined, join = st_intersects)
    ```

-   find which census tracts had blackouts

    ```{r, eval=FALSE}
    # name census tracts w/blackouts (too many to print, eval=FALSE)
    unique(full_bo_data$census_tract)
    ```

    ```{r}
    # check number of census tracts w/black outs
    tract_bo_count <- length(unique(full_bo_data$census_tract))
    sprintf("Number of census tracts with blackouts: %d", tract_bo_count)
    ```

##### compare incomes of impacted tracts to unimpacted tracts (10 points)

-   create a map of median income by census tract, designating which tracts had blackouts

**-1 plotted all buildings instead of designating tracts**

    ```{r, warning=FALSE}
    #update polygon crs to use here
    houston_polygon <- st_transform(houston_polygon, crs = "EPSG:3083")

    # crop full texas to Houston for basemap
    houston_basemap <- st_crop(inc_tract_joined, houston_polygon)
    ```

    ```{r}
    ggplot() +
      geom_sf(data = houston_basemap, aes(fill = median_income)) + #color by inc data
      scale_fill_gradient(low = '#D5F5E3', high = '#186A3B') + #set low+high inc gradient
      labs(fill = "Median Icome",
           title = "2021 Houston Winter Storm Blackout Areas") +
      geom_sf(data = full_bo_data, color = '#8C0D50', alpha = 0.2) + #add bo areas
      annotation_scale(pad_x = unit(8.4, 'cm'), #add scale, adjust size and position
                       pad_y = unit(0.5, 'cm'),
                       height = unit(0.2, 'cm')) +
      annotation_north_arrow(height = unit(0.7, 'cm'), #add arrow, adjust size and position
                             width = unit(0.7, 'cm'),
                             pad_x = unit(11.2, "cm"),
                             pad_y = unit(9.5, "cm")) +
      theme_minimal() + #change theme, lighten graticultes
      theme(plot.title = element_text(hjust = 0.5)) #center title
    ```

-   Plot the distribution of income in impacted and unimpacted tracts

**-1 impacted and unimpacted have many duplicates which effects distribution**

    ```{r}
    # drop geometries of bo data to anti-join w/non-blackout
    impacted <- full_bo_data %>% st_drop_geometry() %>% 
      select('GEOID_Data', 'census_tract', 'median_income')

    #anti-join to find areas w/NO blackouts
    unimpacted <- anti_join(x = inc_tract_joined, y = impacted, by = "census_tract")
    ```

    ```{r, warning=FALSE}
    impacted_distribution <- ggplot(data = impacted, aes(x=median_income)) +
      geom_histogram(fill = '#8C0D50', bins = 50) +
      labs(title = "Income - Areas Impacted by Blackouts",
           x="Median Income",
           y="Frequency") +
      theme_minimal()

    unimpacted_distribution <- ggplot(data = unimpacted, aes(x=median_income)) +
      geom_histogram(fill = '#16A085', bins = 50) +
      labs(title = "Income - Areas Unimpacted by Blackouts",
           x="Median Income",
           y="Frequency") +
      theme_minimal()

    grid.arrange(impacted_distribution, unimpacted_distribution, ncol=1)
    ```

-   write approx. 100 words summarizing your results and discussing any limitations to this study

    This study uses aerial images of night lights in Houston to asses blackouts caused by a winter storm in February 2021. The difference in radiance between a night before and during the storm was used to determine areas where blackouts occurred. In order to improve this estimate, areas within 200m of highways were removed to avoid designating more rural areas as having had blackouts. Finally, homes in blackout areas were combined with data on the corresponding census tract and median income. Based on the distribution, displayed above, there does not appear to be a clear relationship between median income and whether or not an area experienced a blackout. Although there are more areas impacted by blackouts with a median income under 50,000, there are also many high income areas (around 150,000) that were also impacted. This study provides a meaningful preliminary exploration on the relationship socioeconomic factors and the 2021 winter storm blackouts, but more work could be done. Using changes in night lights from two nights does not tell us about potential disparities regarding emergency resource distribution, blackout length, or individual impacts.
